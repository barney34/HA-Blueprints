blueprint:
  name: Presence Light Commander
  author: sholland
  description: >
    v3.1 - The Reboot-Proof Edition.
    - PERSISTENT TIMERS: Uses state-tracking so transitions survive HA restarts.
    - STANDALONE: No external scripts required.
    - RESTART MODE: Re-entry instantly cancels all pending fades.
    - OVERRIDES: 'Disable Trigger' (ON = no lights) and 'Block Turn Off' (ON = stay on).
    - AL COMPATIBLE: Uses native transitions to keep Adaptive Lighting happy.
  domain: automation
  input:
    presence_sensor:
      name: Primary Presence Sensor
      selector:
        entity:
          domain: binary_sensor
          device_class: occupancy
    target_light:
      name: Managed Light
      selector:
        entity:
          domain: light
    # --- OPTIONAL OVERRIDES ---
    disable_switch:
      name: Disable Trigger Switch (Optional)
      default: 
      selector:
        entity:
          domain: [input_boolean, switch, binary_sensor]
    block_off_switch:
      name: Block Turn Off Switch (Optional)
      default: 
      selector:
        entity:
          domain: [input_boolean, switch, binary_sensor]
    # --- DEPENDENCIES ---
    dependency_entities:
      name: Secondary Occupancy/Lights (Optional)
      default: []
      selector:
        entity:
          multiple: true
    # --- TIMING ---
    fade_duration:
      name: Fade Duration
      default: 45
      selector:
        number:
          min: 5
          max: 300
          unit_of_measurement: seconds

mode: restart 

variables:
  disable_ent: !input disable_switch
  block_ent: !input block_off_switch
  deps: !input dependency_entities
  light_ent: !input target_light
  fade_val: !input fade_duration
  sensor_ent: !input presence_sensor

trigger:
  # 1. Standard Motion
  - platform: state
    entity_id: !input presence_sensor
    to: "on"
    id: "occupied"
  - platform: state
    entity_id: !input presence_sensor
    to: "off"
    id: "clear"
  # 2. Dependency Clear
  - platform: state
    entity_id: !input dependency_entities
    to: "off"
    id: "dependency_cleared"
  # 3. THE REBOOT TRIGGER: Run this logic whenever HA starts up
  - platform: homeassistant
    event: start
    id: "reboot"

action:
  - choose:
      # --- SCENARIO 1: OCCUPIED (Turn ON) ---
      - conditions:
          - condition: trigger
            id: "occupied"
          - condition: template
            alias: "Logic: Only run if NOT disabled"
            value_template: "{{ disable_ent == none or is_state(disable_ent, 'off') }}"
        sequence:
          - action: light.turn_on
            target:
              entity_id: !input target_light

      # --- SCENARIO 2: CLEAR OR REBOOT (The Fade/Off Logic) ---
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: "clear"
              - condition: trigger
                id: "dependency_cleared"
              - condition: trigger
                id: "reboot"
          # Only proceed if the room is actually empty
          - condition: state
            entity_id: !input presence_sensor
            state: "off"
        sequence:
          # A. Dependency Check: Ensure secondary items are off
          - condition: template
            alias: "Wait for secondary entities"
            value_template: >
              {% if deps == none or deps == [] %} true
              {% else %} {{ expand(deps) | selectattr('state', 'eq', 'on') | list | count == 0 }}
              {% endif %}

          # B. Block Check (Party Mode)
          - condition: template
            alias: "Check if turn-off is blocked"
            value_template: "{{ block_ent == none or is_state(block_ent, 'off') }}"

          # C. The Native Fade
          - action: light.turn_off
            target:
              entity_id: !input target_light
            data:
              transition: "{{ fade_val }}"

          # D. THE PERSISTENT WAIT: 
          # Instead of a 'delay', we wait for the sensor to have been off for the fade time.
          # If HA reboots, this 'wait' recalculates based on actual clock time.
          - wait_for_trigger:
              - platform: template
                value_template: "{{ (as_timestamp(now()) - as_timestamp(states[sensor_ent].last_changed)) > (fade_val | int + 5) }}"
            timeout: "00:06:00" # Safety timeout (6 minutes)

          # E. Final Verification (The Hard Kill)
          - if:
              - condition: template
                alias: "Is light still on and NOT blocked?"
                value_template: >
                  {{ is_state(light_ent, 'on') and 
                     (block_ent == none or is_state(block_ent, 'off')) }}
            then:
              - action: light.turn_off
                target:
                  entity_id: !input target_light
