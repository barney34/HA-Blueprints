blueprint:
  name: Presence Light Commander
  author: sholland
  description: >
    v2.5 - Professional Presence Engine.
    - RESTART MODE: Re-entry instantly cancels all pending fades and failsafes.
    - OVERRIDES: 'Disable Trigger' (ON = no lights) and 'Block Turn Off' (ON = stay on).
    - AL COMPATIBLE: Uses a clean turn-on to ensure Adaptive Lighting stays in Automatic Mode.
    - PREREQUISITE: Requires 'Ashley's Light Fader' (script.ashley_s_light_fader_2).
  domain: automation
  input:
    presence_sensor:
      name: Primary Presence Sensor
      selector:
        entity:
          domain: binary_sensor
          device_class: occupancy
    target_light:
      name: Managed Light
      selector:
        entity:
          domain: light
    # --- OPTIONAL OVERRIDES ---
    disable_switch:
      name: Disable Trigger Switch (Optional)
      description: "If this switch is ON, the automation will NOT turn the light on (e.g., Night Mode)."
      default: 
      selector:
        entity:
          domain: [input_boolean, switch, binary_sensor]
    block_off_switch:
      name: Block Turn Off Switch (Optional)
      description: "If this switch is ON, the automation will NOT turn the light off (e.g., Party Mode)."
      default: 
      selector:
        entity:
          domain: [input_boolean, switch, binary_sensor]
    # --- DEPENDENCIES ---
    dependency_entities:
      name: Secondary Occupancy/Lights (Optional)
      description: "The countdown will NOT start until ALL of these are also OFF."
      default: []
      selector:
        entity:
          multiple: true
    # --- TIMING ---
    fade_duration:
      name: Fade Duration
      default: 45
      selector:
        number:
          min: 5
          max: 300
          unit_of_measurement: seconds

mode: restart 

variables:
  disable_ent: !input disable_switch
  block_ent: !input block_off_switch
  deps: !input dependency_entities
  light_ent: !input target_light
  fade_val: !input fade_duration

trigger:
  - platform: state
    entity_id: !input presence_sensor
    to: "on"
    id: "occupied"
  - platform: state
    entity_id: !input presence_sensor
    to: "off"
    id: "clear"
  - platform: state
    entity_id: !input dependency_entities
    to: "off"
    id: "dependency_cleared"

action:
  - choose:
      # --- 1. OCCUPIED (Turn ON) ---
      - conditions:
          - condition: trigger
            id: "occupied"
          - condition: template
            alias: "Logic: Only run if NOT disabled"
            value_template: "{{ disable_ent == none or is_state(disable_ent, 'off') }}"
        sequence:
          # Clean turn_on. No data/transition = AL handles everything automatically.
          - action: light.turn_on
            target:
              entity_id: !input target_light

      # --- 2. CLEAR (Fade Out) ---
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: "clear"
              - condition: trigger
                id: "dependency_cleared"
          - condition: state
            entity_id: !input presence_sensor
            state: "off"
        sequence:
          # A. Dependency Check
          - condition: template
            alias: "Stop if dependencies are still active"
            value_template: >
              {% if deps == none or deps == [] %} true
              {% else %} {{ expand(deps) | selectattr('state', 'eq', 'on') | list | count == 0 }}
              {% endif %}

          # B. Block Check
          - condition: template
            alias: "Stop if Turn-Off is blocked"
            value_template: "{{ block_ent == none or is_state(block_ent, 'off') }}"

          # C. Execute Graceful Fade
          - action: script.ashley_s_light_fader_2
            data:
              light: !input target_light
              endBrightnessPercent: 0
              transitionTime:
                seconds: "{{ fade_val }}"
              stopEntity: !input presence_sensor
              lampBrightnessScale: "zeroToTwoFiftyFive"
              easingTypeInput: "easeInQuart"
              endBrightnessEntityScale: "zeroToOneHundred"
              autoCancelThreshold: 10
              shouldStopIfTheLampIsTurnedOffDuringTheFade: true

          # D. Failsafe Delay
          - delay:
              seconds: "{{ (fade_val | int) + 10 }}"
          
          # E. Verification (The Hard Kill)
          - if:
              - condition: template
                alias: "Is light still on and NOT blocked?"
                value_template: >
                  {{ is_state(light_ent, 'on') and 
                     (block_ent == none or is_state(block_ent, 'off')) }}
            then:
              - action: light.turn_off
                target:
                  entity_id: !input target_light
